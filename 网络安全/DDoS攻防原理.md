# DDoS

[toc]

DDoS(Distributed denial of service 分布式拒绝服务)：通过分布式的**多个来源**，组成**僵尸网络**(BotNet)，向目标服务器或网络设备发送大量的**网络请求**或**数据包**，导致服务器资源消耗殆尽或超负荷，无法正常处理合法用户的请求，从而使服务不可用。

1.   分布式：DDoS攻击由多个设备发起，通常用来不同的地理位置，所以通过简单的封禁IP无法阻止。
2.   高流量：攻击者发送大量流量使目标网络阻塞或资源耗尽，造成服务中断。
3.   资源耗尽：通过占用服务器的CPU、内存、带宽等资源，使其超负荷，从而无法处理正常用户的请求。

## 攻击方式

### ICMP 洪水 和 UDP 洪水

ICMP 洪水：利用Internet控制消息协议(ICMP)，向目标服务器发送大量的ICMP数据包。最常见的类型是ICMP Echo请求(ping请求)。

UDP 洪水和ICMP 洪水类似，但是由于UDP是无连接的，所以攻击者可以轻松的生成大量的数据包。

>   为了不暴露攻击设备的IP地址，而被对方封禁，所以攻击者一般通过隐藏IP地址隐藏自己。

### 反射攻击

攻击者将自己伪造成目标服务器(伪造IP)向第三方服务器(反射器)发送网络请求，第三方服务器会将数据包发送给目标服务器。

~~~ mermaid
---
title: "反射攻击"
---
graph LR
攻击者 --发送请求--> server["`第三方服务器(反射器)`"]
server --返回数据--> 目标服务器
~~~

#### DNS 反射攻击

攻击者向开放的DNS服务器发送请求，伪造IP为目标服务器的IP，DNS服务器响应的数据包会被发送到目标服务器。

~~~ mermaid
---
title: "DNS反射攻击"
---
graph LR
攻击者 --发送请求--> server["`DNS服务器(反射器)`"]
server --返回数据--> 目标服务器
~~~

1.   DNS 查询请求小，响应大。返回的数据可能包含多个记录。
2.   许多DNS服务器配置为开放解析器，允许来自任何IP地址的请求，无条件的回应伪造的请求。
3.   DNS使用UDP协议，无需建立连接就可以以低成本发送大量请求。

### TCP 洪水

TCP的连接表的大小是有限的，攻击者通过发起大量的TCP连接，占满目标服务器的TCP连接表，导致目标服务器无法建立新的连接。

>   由于TCP连接需要进行三次握手，所以无法伪造IP

### SYN洪水

>   在建立TCP连接时，客户端首先发送一个SYN包请求连接，服务器回复一个SYN-ACK包确认，然后客户端在发送一个ACK包完成连接，这个过程称为TCP三次握手

攻击者向目标服务器发送大量的伪造SYN包，目标服务器收到SYN请求后，会为每个请求分配资源，并回复SYN-ACK包，由于IP地址时伪造的,服务器无法完成连接，导致分配的资源无法释放(重传机制)。

#### SYN反射

~~~ mermaid
---
title: "SYN反射"
---
graph LR
攻击者 --SYN数据包--> server["`第三方服务器(反射器)`"]
server --SYN+ACK数据包--> 目标服务器
~~~

但是由于无法在目标服务器上建立连接，所以这种攻击方式更大程度上只是攻击网络带宽

### RST洪水攻击

>   在TCP连接中，RST包用于立即终止连接。

RST洪水攻击中，攻击者发送大量的伪造RST包，这些包伪造成随机或其他连接的IP地址，当目标服务器收到RST包时，会立即终止这些连接，这会导致正常的TCP连接被关闭。

~~~ mermaid
graph LR

攻击者--伪造的RST包-->目标服务器 --切断连接--x正常用户
~~~

### HTTP洪水攻击

攻击者通过向目标网站或服务器发送大量的http请求，例如发送大量的get关键词搜索请求，目标服务器在收到请求后需要在后端中处理这些业务代码，从而占用服务器的IO资源。

>   由于http协议是基于tcp协议的，所以不能伪造IP，通常是攻击者利用多个被感染的设备，向目标服务器进行攻击

## DDoS防御

### 内容分发网络 CDN

CDN服务商在全球各地部署了多个节点，这些节点缓存了源服务器上的静态和动态资源。

当用户访问网站时，DNS会将用户的请求指向最近的CDN节点，而不是源服务器。

当被攻击时，恶意的流量会被分散到各个CDN服务器，从而达到稀释攻击的效果。

~~~ mermaid
mindmap
    server)服务器(
    	(CDN)
    		客户端
    		客户端
    		客户端
    	(CDN)
    		客户端
    		客户端
    		客户端
    	
    	(CDN)
    		客户端
    		客户端
    		客户端
    	
       

~~~

### 防火墙

#### 状态检测

防止SYN洪水攻击和UDP洪水攻击：状态检测能够监测流量和TCP连接建立过程。当检测到大量的SYN请求或者异常流量时，识别并限制流量进行过滤。

状态检测还能区分合法流量和伪造的流量。

#### 流量清洗

通过硬件或云服务，使用多种检测技术，识别出潜在的DDoS攻击，对流量进行过滤。

~~~ mermaid
graph LR
客户端1--恶意流量--xa(流量清洗设备)--正常流量-->服务器
客户端2--正常流量-->a

~~~

#### 缩小暴露面积

隔离资源和其他不相关的业务，避免非业务的服务端口暴露在公网上

#### 流量阈值

当流量超过阈值，自动限制 或阻止来源IP的请求。

防止占用网络带宽，（HTTP洪水攻击）

#### 速率限制

限制一定时间内，一个IP的请求次数。防止IO资源占用。(HTTP洪水攻击)

#### 白名单和黑名单

拒绝恶意IP进行访问。(对DNS服务器设置白名单，降低受到DNS反射攻击的可能)

### 其他手段

1.   验证码：对于一些比较消耗资源的动作，需要用户输入验证码，来过滤自动化脚本的攻击。
2.   负载均衡：通过负载均衡器将流量分散到多个服务器上，降低单台服务器的压力。
3.   积极为服务器系统打补丁，修复程序已知漏洞。











* ICMP洪水：禁用ICMP规则、速率限制
* UDP洪水：负载均衡、流量和速率限制
* 反射攻击：流量清洗、CDN
* DNS反射攻击：DNS服务器白名单
* TCP洪水：限制每个IP地址的连接速率或总连接数、流量清洗、负载均衡、黑名单
* SYN洪水： 状态检测、SYN Cookies、连接池
* RST洪水： 状态检测
* HTTP洪水：CDN、负载均衡、WAF、速率限制、验证码
