[toc]

# 输入输出

* 输入输出设备
* 输入输出接口
* 输入输出软件

## I/O系统的特点

* 复杂性
* 异步性
* 实时性
* 与设备无关性

## IO接口的基本功能

### IO接口要解决的问题

外部接口的种类繁多，有机械式、电子式和其他形式。他们涉及的信息类型也不相同，可以是数量、模拟量或开关量。因此，CPU与外部设备之间交换信息时需要解决以下问题：

1. 速度匹配问题：CPU的速度很高，而外设速度有高有低，而且不同的外设速度差异甚大。
2. 信号电平和驱动能力问题：CPU的信号都是TTL电平（一般在0～5V之间），而且提供的功率很小，而外设需要的电平要比这个范围宽得多，需要的驱动功率也较大。
3. 信号形式匹配问题：CPU只能处理数字信号，而外设的信号形式多种多样，有数字量、开关量、模拟量（电流，电压，频率，相位），甚至还有非电量，如电压、流量、温度、速度等。
4. 信息格式问题：CPU在系统总线传送的是8位，16位或32位并行二进制数据，而外部使用的信号形式信息格式各不相同。
5. 时序匹配问题：CPU的各种操作都是在统一的时钟信号作用下完成的，各种操作都有自己的总线周期，而各种外设不能直接与CPU的系统总线相连。

### IO接口的功能

接口电路应该具有如下功能：

1. IO地址译码与设备选择。
2. 信息的输入输出。
3. 命令、数据的状态的缓冲与锁存。
4. 信息转换。

### IO端口的编址方式

IO端口包括3中类型：

1. 数据端口：输入/输出数据
2. 状态端口：读入设备当前状态
3. 命令端口：向外发出控制命令

8088/8086CPU最多能够管理64K各端口。
当一个外设有多个端口时，为方便管理，通常是为其分配一个连续的地址块，这个地址块中最小的那个地址称谓（外设的）基地址。

在微型计算机系统中，IO端口的编制通常有两种不同的方式：

1. 与内存单元统一编址
2. 独立编址

#### IO端口与内存单元统一编址

IO端口与内存单元统一编址方式又称存储器映射编址方式，即把每个IO端口都当作一个存储单元看待，端口与存储器单元在同一个地址空间中进行编址。通常是在整个地址空间中划分出一小块连续的地址分配给IO端口。被端口占用了的地址，存储器不能在使用。

> 优点：可以用访问内存的方法来访问IO端口。由于访问内存的指令种类丰富、寻址方式多样，因此这种编址方式为访问外设带来了很大的灵活性。理论上讲，所有用于内存的指令都可以用于外设，不再需要专门的IO指令。同时，IO控制信号也可以与存储器的控制信号共用，从而给应用带来了很大方便
>
> 缺点：占用了一部分内存地址空间，减少了内存可用的地址范围。不容易区分当前是对内存进行操作还是对外设进行操作。

#### IO端口独立编址

IO端口独立编址时，内存地址空间和外设地址空间是相互独立的。

> 8086/8088系统的内存地址范围为00000H～FFFFFH,而外设端口的地址范围为0000H～FFFFH这两个地址空间相互独立，互不影响。

IO端口独立编址的特点：

1. IO端口的地址空间与内存地址空间完全独立
2. IO端口与内存使用不同的控制信号
3. 指令系统中设置了专门用于访问外设的IO指令

## 基本的输入输出方式

* 无条件传送
* 查询
* 中断
* 直接存储器存取（DMA）

### 无条件传送方式

无条件传送指令主要用于外部控制过程中的各种动作是固定的而且是已知的，控制的对象是一些简单的、随时“准备好”的外设。随时可以接收CPU输出的数据或者他们的数据随时都可以被CPU读出，即CPU可以不必查询外设当前的状态而无条件的进行数据的输入输出。

> 与外设交换的过程中，数据交换与指令的执行是同步的，因此这种方式也可以称为 **同步传送**方式

### 查询方式

CPU在数据传送前必须要先查询一下外设是否准备好，若没准备好就要等待

缺点：查询过程中不能在做被的事，这样大大降低了CPU的效率。而且假如某一外设刚好在查询过之后就处于就绪状态，那么也必须等到CPU查询完所有外设，CPU才能发现它处于就绪状态，然后才能对此外设服务。这使得数据交换的实时性较差，对于许多实时性要求较高的外设来说，就有可能丢失数据。

因此，利用查询方式与外设进行数据交换，需要满足以下两点：

1. 连接到系统的外部设备是简单的、慢速的，且对实用性要求不高。
2. 连接到同一系统的外设，其工作速度是相近的。如果速度相差过大，可能会造成某些设备的数据丢失。

### 中断方式

CPU不主动介入外设的数据传输工作，而是由外部设备在需要进行数据传送时向CPU发出中断请求，CPU在接受到请求后若条件允许，则中断正在进行的工作而转去对该外设服务，并在服务结束时回到原有的工作，从而提高CPU的利用率。

> 为了能够回到原来的地方，要求响应中断前必须将返回地址和程序运行状态保存起来。这个过程称为**断点保护**。

### 直接存储器存取方式

外设不通过CPU而直接与存储器进行信息交换 （DMA）。

通过特殊硬件电路来控制存储器与外设直接进行数据传送。这个硬件称为DMA控制器。



-----

# 中断技术

中断技术在计算机中应用极为广泛，它不仅可用于数据传输、提高数据传输过程中CPU的利用率，开可以用来处理一些需要实时响应的事件，例如异常、时钟、掉电、特殊状态等。在操作系统中，还使用中断来进行一些系统级的特殊操作，如虚拟存储器页面的调入调出等。

## 中断概念

在微机中，当CPU执行程序过程时，由于随机事件引起CPU暂时停止正在执行的程序，而转去执行一个用于处理该事件的程序，称为中断服务程序（或中断处理程序），处理完成后又返回被终止的程序断点处继续执行，这一过程被称为**中断**。

引起中断的事件称为中断源，中断源分为两类：

1. 来自CPU内部，称为内部中断源
2. 来自CPU外部，称为外部中断源

内部中断源主要包括：

1. CPU执行指令的时产生异常，如被0除，溢出、断点、单步操作等;
2. 特殊操作引起的异常，如存储器越界，缺页等;
3. 由程序员安排在程序中的INTn软件中断指令。

外部中断源主要包括：

1. IO设备，如键盘，打印机，鼠标等。
2. 数据通道，如磁盘，数据采集装置、网络等。
3. 实时钟，如定时器时间到。
4. 故障源，如掉电，硬件错，存储器奇偶校验错等。

## 中断处理的一般过程

1. 中断请求
2. 中断源识别（中断判优）
3. 中断响应
4. 中断处理
5. 中断返回

## 内部中断——软中断

在8086/8088系统中，通过执行中断指令或CPU本身启动的中断称为内部中断。

除单步中断外，内部中断无法用软件禁止，即不受IF影响

### 内部中断的类型

1.   0型中断——除法出错中断
2.   1型中断——单步中断
3.   3型中断——断点中断
4.   4型中断——溢出中断
5.   INT n 指令中断

#### 中断类型码

专用中断：中断类型码是自动形成的

集中类型码为：类型0、1、3、4。

对于INT n指令，起类型码为指令给出的n。

获得类型码后的处理过程：

1.   类型码\*4->向量表指针。
2.   标志寄存器FR入栈，保护各个标志。
3.   清除IF和TF标志，屏蔽新的INTR中断和单步中断。
4.   保存断点（断点处IP和CS压栈，先压CS后压IP）。
5.   从中断向量表中去除中断服务程序入口地址分别送入IP和CS中。
6.   按新的地址执行中断服务程序

## 外部中断——硬中断

非屏蔽中断——NMI引脚产生的中断，不受IF控制，类型号为2。

可屏蔽中断——由CPU的INTR端接收可屏蔽的中断。受IF控制，只有当IF=1，在一条指令执行结束后，CPU才能相应可屏蔽中断的请求。

>   优先级 软中断(除单步)>硬中断>单步中断

# 8259A 可编程中断控制器

![8259A内部](https://bkimg.cdn.bcebos.com/pic/14ce36d3d539b60038036e38ec50352ac75cb76b?x-bce-process=image/resize,m_lfit,w_536,limit_1/quality,Q_70)

![8259A](https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/Intel_8259.svg/220px-Intel_8259.svg.png)

Intel 8259A是8086系列CPU兼容的可编程中断控制器，它的主要功能是：

1.   具有8级优先权控制，级联可扩展至64级
2.   每一级中断都可以屏蔽或允许
3.   在中断响应周期，8259A可提供相应的中断向量号(中断类型号)。
4.   8259A的工作方式，可通过编程来进行选择。

*   D~7~——D~0~：数据总线(双向)
*   RD\\：读输入
*   WR\\：写输入
*   A~0~：命令选择地址
*   CS\\：片选
*   CAS~2~——CAS~0~：级联线
*   SP\\——EN\\：从程序/允许缓冲
*   INT：中断输出
*   INTA\\：中断响应输入
*   IR~0~——IR~7~：中断请求输入

## 8259A的编程

### 初始化编程

由CPU向8259A送入2\~4字节的初始化命令字ICW

### 工作方式编程

由CPU向8259A送三个字节的工作命令字OCW，以规定8259A的工作方式。该命令可在8259A初始化命令字ICW后的任何时间写入。

#### ICW1——芯片控制字

![ICW1](https://bkimg.cdn.bcebos.com/pic/060828381f30e924e6ee15ad4d086e061c95f7e0?x-bce-process=image/format,f_auto/watermark,image_d2F0ZXIvYmFpa2UyNzI,g_7,xp_5,yp_5,P_20/resize,m_lfit,limit_1,h_1080)

#### ICW2——中断类型控制字(中断类型码):star:

![ICW2](https://bkimg.cdn.bcebos.com/pic/c8177f3e6709c93d7121876b9e3df8dcd000545e?x-bce-process=image/format,f_auto/watermark,image_d2F0ZXIvYmFpa2UyNzI,g_7,xp_5,yp_5,P_20/resize,m_lfit,limit_1,h_1080)

#### ICW3——主/从片初始化(级连控制字)

![ICW3](https://odmg.pages.dev/file/c8c37132f7da35d2d8118.png)

#### ICW4——方式控制字

![ICW4](https://odmg.pages.dev/file/00275448c12932b9c3798.png)

#### OCW1——屏蔽操作命令字

用来设置或清除对中断的屏蔽(设置IMR的值)

![image-20240311205805809](./assets/image-20240311205805809.png)

#### OCW2——中断方式命令字

设置优先级循环和中断结束方式

![image-20240311205910713](./assets/image-20240311205910713.png)

#### OCW3——状态操作命令字

设置和撤销特殊屏蔽方式、设置中断查询方式、设置对8259A内部寄存器的读出命令。

![image-20240311210056861](./assets/image-20240311210056861.png)
